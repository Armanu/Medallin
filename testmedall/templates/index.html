{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta charset="utf-8">
<title>مدالین</title>
<link rel = "stylesheet"
type = "text/css"
<<<<<<< Updated upstream
href = "{% static 'css/main.css' %}"/>
<!-- href = "../static/css/main.css" -->

=======
href = "main.css" />
>>>>>>> Stashed changes
</head>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<body>
    <div class="mainContainer">
               <div class="div2" id="divid2"><div class="but3"> <div class="Bmbox">
            این یک نسخه ی آزمایشی از مدالین است . مدالین یک سامانه ی خودارزیابی پزشکی آزاد است. میتوانید کد مدالین را بر روی گیت هاب به این آدرس پیدا کنید. <a href="https://github.com/Armanu/Medallin">Medallin</a><br>راه ارتباطی با من : <a href=mailto:gorjiarman@gmail.com>gorjiarman@gmail.com</a>
            <br>برای شروع سن خود را وارد کنید.
               </div></div></div>
        <div class="iii">
        <div class="helper" id="helperid">راهنما : سن خود را وارد کنید.</div>
        <input type="text" placeholder="اینجا بنویسید..." id="myInput" class="textbox">
        <button type="button" onclick="getInputValue();" class="but" id="butid">ارسال</button>
    </div>
    <script>
        con = 1;
        var age ="";
        var gender="";
        var diseases;
        var symptoms_name;
        var answerSymptomString;
        var mySymptoms= new Object();
        function getInputValue(){
<<<<<<< Updated upstream
            
           if(con ==1)
            {            getMessage();

=======
            getMessage();
            if(con ==0)
            {
                setHelper("در حال به روز رسانی...صبر کنید.");
                var btn = document.createElement("DIV");
                btn.style.fontSize="5vh";
                document.getElementById("butid").innerHTML="ارسال";
                btn.innerHTML = "سلام، چند سالتونه؟";
                setHelper("سن خود را به عدد وارد کنید.")
                document.getElementById("divid2").appendChild(btn);
// <!--                axios.defaults.headers.post['Content-Type'] ='application/json';-->
// <!--                axios.get('http://185.97.117.155/api/list/symptoms/', { headers: {-->
// <!--                'Accept-Language': 'fa',-->
// <!--                Authorization: 'Bearer 5775e6158ce345feb2b4988b4c7d940f' } })-->
// <!--                    .then((response) => {-->
// <!--                        symptoms_name = response.data;-->
// <!--                        axios.get('http://185.97.117.155/api/list/diseases/', { headers: {-->
// <!--                        'Accept-Language': 'fa',-->
// <!--                         Authorization: 'Bearer 5775e6158ce345feb2b4988b4c7d940f' } })-->
// <!--                            .then((response) => {-->
// <!--                                diseases = response.data;-->
// <!--                            }).catch((error) => {-->
// <!--                                console.log(error);-->

// <!--                }).then(() => {-->
// <!--                    console.log('fuckedup');-->
// <!--                });-->
// <!--                   -->
// <!--                }).catch((error) => {-->
// <!--                    console.log(error);-->
// <!--                }).then(() => {-->
// <!--                    console.log('fuckedup');-->
// <!--                });-->
                con++;
            }
            else if(con ==1)
            {
>>>>>>> Stashed changes
                age = document.getElementById("myInput").value;
                console.log(age);
                var btn = document.createElement("DIV");
                var cbtn = document.createElement("DIV");
                cbtn.setAttribute("class","but2");
                btn.setAttribute("class","Bmbox");
                btn.style.fontSize="5vh";
                btn.innerHTML = "مرد یا زن ؟";
                setHelper("جنسیت خود را وارد کنید")
                cbtn.appendChild(btn);
                document.getElementById("divid2").appendChild(cbtn);
                con++;
            }
            else if(con ==2)
            {            getMessage();

                gender = document.getElementById("myInput").value.replace("مرد","male").replace("زن","female");
                console.log(gender);
                var btn = document.createElement("DIV");
                var cbtn = document.createElement("DIV");
                cbtn.setAttribute("class","but2");
                btn.setAttribute("class","Bmbox");
                btn.style.fontSize="5vh";
                btn.innerHTML = "مشکلتون چیه ؟";
                setHelper("مانند؛ تب ، سردرد، سرفه")
                cbtn.appendChild(btn);
                document.getElementById("divid2").appendChild(cbtn);
                con++;
            }
            else if(con ==3)
            {            getMessage();

                var symptom = document.getElementById("myInput").value;
                getPredictFromSymptom(symptom,1);
<<<<<<< Updated upstream
=======
// <!--                searchedID = getConceptFromString(symptom);-->
// <!--                console.log(searchedID);-->
>>>>>>> Stashed changes
                con++;
            }
            else if(con ==4)
            {            getMessage();

                console.log('here we are');
                var answer = document.getElementById("myInput").value;
<<<<<<< Updated upstream
=======
// <!--                searchedID = getConceptFromString(answer);-->
// <!--                console.log(searchedID);-->
>>>>>>> Stashed changes
                if(answer =="y")
                {

                    getPredictFromSymptom(answerSymptomString,1);
                }
                else if(answer =="n")
                {
                    getPredictFromSymptom(answerSymptomString,-1);
                }
                else if(answer=="u")
                {
                    getPredictFromSymptom(answerSymptomString,0);
                }
                else
                {
                    var btn = document.createElement("DIV");
                    var cbtn = document.createElement("DIV");
                    cbtn.setAttribute("class","but2");
                    btn.setAttribute("class","Bmbox");
                    btn.style.fontSize="5vh";
                    btn.innerHTML = 'چی؟';
                    cbtn.appendChild(btn);
                    document.getElementById("divid2").appendChild(btn);
                }

            }

            document.getElementById("myInput").value="";

        }
        function getPredictFromSymptom(symptomString,symptomValue)
        {
            getConceptFromString(symptomString).then((response) => {
            var symptomsString='{';
<<<<<<< Updated upstream
            mySymptoms['"'+response+'"'] = symptomValue;
            console.log( response);
=======
            searchedID = getConceptFromString(symptomString);

// <!--            translatedsymptom = getKeyByValue(symptoms_name,symptomString);-->
            mySymptoms['"'+searchedID+'"'] = symptomValue;
            console.log(searchedID);
>>>>>>> Stashed changes
            var bodyFormData = new FormData();
            for(mySymptom in mySymptoms)
            {
                symptomsString+=`${mySymptom}: ${mySymptoms[mySymptom]},`;
            }
            symptomsString+='}'
            symptomsString=symptomsString.replace(",}","}");
            bodyFormData.set('profile', '{"age": '+age+',"gender": "'+gender+'"}');
            bodyFormData.set('symptoms', symptomsString);
            console.log( '{"age": '+age+',"gender": "'+gender+'"}');
            console.log(symptomsString);
            axios.defaults.headers.post['Content-Type'] ='application/json';
            axios.post('https://www.medallin.ir/api/predict/', bodyFormData, { headers: {
          
            Authorization: 'Bearer 5775e6158ce345feb2b4988b4c7d940f'
            }})
                .then((response) => {
                    console.log(response.data);
                   // getPredictFromId(response.data.id)
                }).catch((error) => {
                    console.log(error);
                }).then(() => {
                    console.log('fuckedup');
                });
            });

        }

        function getPredictFromId(id)
        {
            axios.get('https://www.medallin.ir/api/predict/?id='+id, { headers: {
                Authorization: 'Bearer 5775e6158ce345feb2b4988b4c7d940f' ,
                  'Accept-Language': 'fa'
            } })
                    .then((response) => {
                        console.log(response.data);
                        if(response.data.status=="pending")
                        {
                            getPredictFromId(id)
                        }
                        else
                        {
                            console.log(response.data);
                            answers="";
                            const forLoop = async _ => {
                            console.log('Start')

                            for (let index = 0; index < 10; index++) {
                           
                                answer="";
                                console.log(response.data.result.predictions[index][0]);
                                await axios.get('https://www.medallin.ir/api/info/disease/'+response.data.result.predictions[index][0], { headers: {
                                   Authorization: 'Bearer 5775e6158ce345feb2b4988b4c7d940f' ,
                                      'Accept-Language': 'fa'
                                } })
                                .then((response) => {
                                   
                                    answer = response.data.label;
                                   answers+=answer+"<br>";
                                   console.log(answers);

                                }).catch((error) => {
                                    console.log(error);
                                }).then(() => {
                                });                                
                            }
                          
                            }
                            forLoop().then(()=>{
                                var btn = document.createElement("DIV");
                            var cbtn = document.createElement("DIV");
                            cbtn.setAttribute("class","but2");
                            btn.setAttribute("class","Bmbox");
                            btn.style.fontSize="5vh";
                            btn.innerHTML = 'بیماری ها :'+"<br>"+answers;
                            cbtn.appendChild(btn);
                            document.getElementById("divid2").appendChild(cbtn);

                            getStringFromConceptSymptom(response.data.result.suggestions[0]).then((response1) => {
                                
                            console.log('fuckedup');
                            setHelper("y = آره , n = نه , u = نمیدونم");
                            var btn = document.createElement("DIV");
                            var cbtn = document.createElement("DIV");
                            cbtn.setAttribute("class","but2");
                            btn.setAttribute("class","Bmbox");
                            btn.style.fontSize="5vh";
                            btn.innerHTML = "آیا "+ response1+" دارید؟";
                            answerSymptomString = response1;
                            cbtn.appendChild(btn);
                            document.getElementById("divid2").appendChild(cbtn);
                            window.scrollTo(0,document.getElementById("divid2").scrollHeight+300);

                });
                            });
                        }
                }).catch((error) => {
                    console.log(error);
                }).then(() => {
                    
                       
        });
        }
        async function getConceptFromString(string)
        {
            let searchedID;
                await axios.get('https://www.medallin.ir/api/concept/string/'+string, { headers: {
                Authorization: 'Bearer 5775e6158ce345feb2b4988b4c7d940f',  'Accept-Language': 'fa'} })
                    .then((response) => {
                        console.log(response.data);
                        searchedID = response.data.concept_id;
                        console.log(searchedID);
                        return searchedID;
                }).catch((error) => {
                    console.log(error);
                }).then(() => {
                    
                    console.log(searchedID);
                    console.log('fuckedup');
                    return searchedID;

                });
        return searchedID;

        }
        async function getStringFromConceptDisease(concept_id)
        {
            let response;
            await axios.get('https://www.medallin.ir/api/info/disease/'+concept_id, { headers: {
                Authorization: 'Bearer 5775e6158ce345feb2b4988b4c7d940f',  'Accept-Language': 'fa' } })
                    .then((response) => {
                        console.log(response.data);
                        answer = response.data.label;
                        response = answer;
                        console.log(answer);
                        return response;

                }).catch((error) => {
                    console.log(error);
                }).then(() => {
                    console.log('fuckedup');
                     return response;
                });
                return response;
        }
         async function getStringFromConceptSymptom(concept_id)
        {
             let searchedID;
                await axios.get('https://www.medallin.ir/api/info/symptom/'+concept_id, { headers: {
                Authorization: 'Bearer 5775e6158ce345feb2b4988b4c7d940f',  'Accept-Language': 'fa' } })
                    .then((response) => {
                        console.log(response.data);
                        searchedID = response.data.label;
                        console.log(searchedID);
                        return searchedID;
                }).catch((error) => {
                    console.log(error);
                }).then(() => {
                    
                    console.log(searchedID);
                    console.log('fuckedup');
                    return searchedID;

                });
        return searchedID;
        }
        function getKeyByValue(object, value) {
            return Object.keys(object).find(key => object[key] === value);
        }
        function setHelper(message)
        {
            document.getElementById("helperid").innerHTML=message;
        }
        function getMessage()
        {
            var inputString = document.getElementById("myInput").value;
            var btn = document.createElement("DIV");
            var cbtn = document.createElement("DIV");
            cbtn.setAttribute("class","but3");

            btn.setAttribute("class","Umbox");
            btn.style.textAlign ="right"
            btn.style.fontSize="5vh";
            btn.innerHTML = inputString;
            cbtn.appendChild(btn);
            document.getElementById("divid2").appendChild(cbtn);
            window.scrollTo(0,document.getElementById("divid2").scrollHeight+300);

        }

    </script>
 </div>
</body>
</html>
